{% extends "base.html" %}
{% load static %}

{% block content %}
 <div class="main-wrapper">
     <div class="page-wrapper">
        <div class="content content-two create-project">
            <div class="container mt-4">
                <h2>Edit Workers on Order Item: {{ task.order_item.description }}</h2><br>
            
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            
                <form method="POST" id="editTaskForm">
                    {% csrf_token %}            
                    <!-- Workers -->
                    <div class="mb-3">
                        <label for="workers" class="form-label">Select Workers</label>
                        <select name="workers" id="workers" class="form-select select2" multiple required>
                            {% for worker in workers %}
                                <option value="{{ worker.id }}" {% if worker in task.workers.all %}selected{% endif %}>{{ worker.name }} - {{ worker.role }}</option>
                            {% endfor %}
                        </select>
                    </div>
            
                    <!-- Deadline -->
                    <div class="mb-3">
                        <label for="deadline" class="form-label">Deadline</label>
                        <input type="date" name="deadline" id="deadline" value="{{ task.deadline|date:'Y-m-d' }}"  class="form-control" required>
                    </div>
            
                    <!-- Group Task -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="is_group_task" id="is_group_task" disabled>
                        <label class="form-check-label" for="is_group_task">
                            Mark as Group Task
                        </label>
                    </div>
            
                    <!-- Price Per Task -->
                    <div class="mb-3">
                        <label for="price_per_task" class="form-label">Price Per Task</label>
                        <input type="number" step="0.01" name="price_per_task" id="price_per_task" value="{{ task.price_per_task }}" class="form-control" required>
                    </div>
            
                    <!-- Submit -->
                    <button type="submit" class="btn btn-primary">Update Workers</button>
                    <a href="{% url 'managementSystem:view_po' task.order_item.po.id %}" class="btn btn-secondary">Cancel</a>
                </form>
            </div>
        </div>
     </div>
 </div>


 <!-- jQuery -->
    <script src="{% static 'js/jquery-3.7.1.min.js' %}" type=""></script>

    <!-- Bootstrap Core JS -->
    <script src="{% static 'js/bootstrap.bundle.min.js' %}" type="ac3f8615a263811875ad4144-text/javascript"></script>

    <!-- Slimscroll JS -->
    <script src="{% static 'js/jquery.slimscroll.min.js' %}" type="ac3f8615a263811875ad4144-text/javascript"></script>

    <!-- Select2 JS -->
    <script src="{% static 'plugins/select2/js/select2.min.js' %}" type="ac3f8615a263811875ad4144-text/javascript"></script>

    <!-- Datetimepicker JS -->
    <script src="{% static 'js/moment.min.js' %}" type="ac3f8615a263811875ad4144-text/javascript"></script>
    <script src="{% static 'js/bootstrap-datetimepicker.min.js' %}" type="ac3f8615a263811875ad4144-text/javascript"></script>

    <!-- Custom JS -->
    <script src="{% static 'js/script.js' %}" type="ac3f8615a263811875ad4144-text/javascript"></script>

    <script src="{% static 'cdn-cgi/scripts/7d0fa10a/cloudflare-static/rocket-loader.min-2.js' %}" data-cf-settings="ac3f8615a263811875ad4144-|49" defer=""></script>


<script>
document.addEventListener("DOMContentLoaded", function () {
    const groupTaskCheckbox = document.getElementById("is_group_task");

    $('#workers').on('change', function () {
        const selectedCount = $(this).val() ? $(this).val().length : 0;

        if (selectedCount > 1) {
            groupTaskCheckbox.disabled = false;
            groupTaskCheckbox.checked = true;   // auto-check
        } else {
            groupTaskCheckbox.disabled = true;
            groupTaskCheckbox.checked = false;  // uncheck if â‰¤ 1
        }
    });

    // run once on page load (in case workers were already preselected)
    $('#workers').trigger('change');
});
</script>
<script>
document.getElementById('editTaskForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const formData = new FormData(this);

    const response = await fetch("", {
        method: "POST",
        body: formData
    });

    const data = await response.json();
    if (data.success) {
        alert(data.message);
        window.location.href = "{% url 'managementSystem:view_po' task.order_item.po.id %}";
    } else {
        alert(data.message);
    }
});
</script>
{% endblock %}
