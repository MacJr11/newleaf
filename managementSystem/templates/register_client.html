{% extends "base.html" %}
{% load static %}

{% block content %}
    <div class="main-wrapper">
        <div class="page-wrapper">
            <div class="content content-two">

                <!-- Breadcrumb -->
                <div class="mb-4 d-flex align-items-center flex-wrap gap-2 justify-content-between">
                    <div>
                        <h4 class="mb-1 fw-bold">Clients</h4>
                        <nav>
                            <ol class="breadcrumb breadcrumb-dot mb-0">
                                <li class="breadcrumb-item">
                                    <a href="{% url 'dashboard:dashboard'%}">Home</a>
                                </li>
                                <li class="breadcrumb-item active" aria-current="page">Clients</li>
                            </ol>
                        </nav>
                    </div>
                    <div class=" d-flex align-items-center">
                        <a href="javascript:void(0);" class="btn btn-md btn-primary me-2" data-bs-toggle="modal" data-bs-target="#add_clients"><i class="ti ti-plus me-1"></i>Add New Client</a>
                    </div>
                </div>
                <!-- /Breadcrumb -->

                <!-- Search -->
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 table-header mb-3">
                    
                </div>
                <!-- /Search -->

                <!-- Table List -->
                <div class="table-responsive">
                    <table class="table">
                        <thead class="thead-light text-uppercase">
                            <tr>
                                <th class="no-sort">Name</th>
                                <th class="no-sort">Email</th>
                                <th class="no-sort">Phone</th>
                                <th class="no-sort">Address</th>
                                <th class="no-sort">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for client in clients %}
                            <tr>
                                <td> {{client.name}} </td>
                                <td> {{client.contact_email}} </td>
                                <td> {{client.phone}} </td>
                                <td> {{client.address}} </td>
                                <td>
                                    <button class="btn btn-sm btn-warning edit-btn" data-id="{{ client.id }}">Edit</button>
                                    <button class="btn btn-danger btn-sm delete-btn" data-id="{{ client.id }}">Delete</button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">No clients yet</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <div class="pagination">
                        <nav aria-label="Worker pagination" class="pagination-container">
                            <ul class="pagination">
                                {% if clients.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link btn btn-outline-primary" href="?page={{ clients.previous_page_number }}">
                                            &laquo; Previous
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link btn btn-outline-secondary disabled">&laquo; Previous</span>
                                    </li>
                                {% endif %}

                                {% for num in clients.paginator.page_range %}
                                    {% if clients.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link btn btn-primary">{{ num }}</span>
                                        </li>
                                    {% else %}
                                        <li class="page-item">
                                            <a class="page-link btn btn-outline-primary" href="?page={{ num }}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if clients.has_next %}
                                    <li class="page-item">
                                        <a class="page-link btn btn-outline-primary" href="?page={{ clients.next_page_number }}">
                                            Next &raquo;
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link btn btn-outline-secondary disabled">Next &raquo;</span>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                </div>
                <!-- /Table List -->

                <!-- add client -->
                <div class="modal fade" id="add_clients">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="clntFrmTtl">Add Client</h5>
                                <button type="button" class="btn-close custom-btn-close clsrfsh" data-bs-dismiss="" aria-label="Close" id="btncls"><i class="ti ti-x"></i></button>
                            </div>
                            <form method="post" id="clientForm">
                                {% csrf_token %}
                                <input type="hidden" id="client_id" name="client_id">
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Client Name<span class="text-danger ms-1">*</span></label>
                                                <input type="text" class="form-control" name="name" required>
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Address<span class="text-danger ms-1">*</span></label>
                                                <input type="text" class="form-control" name="address" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Email Address<span class="text-danger ms-1">*</span></label>
                                                <input type="email" class="form-control" name="contact_email" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Phone Number<span class="text-danger ms-1">*</span></label>
                                                <input type="text" class="form-control" name="phone" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-white btn-md me-2 clsrfsh" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary btn-md">Add Client</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <!-- jQuery -->
    <script data-cfasync="false" src="{% static 'cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min-2.js' %}"></script>
    <script src="{% static 'js/jquery-3.7.1.min.js' %}" type=""></script>

    <!-- Bootstrap Core JS -->
    <script src="{% static 'js/bootstrap.bundle.min.js' %}" type="3ef0ac283bd62b58e08a32f8-text/javascript"></script>

    <!-- Slimscroll JS -->
    <script src="{% static 'js/jquery.slimscroll.min.js' %}" type="3ef0ac283bd62b58e08a32f8-text/javascript"></script>

    <!-- Datatable JS -->
    <script src="{% static 'js/jquery.dataTables.min.js' %}" type="3ef0ac283bd62b58e08a32f8-text/javascript"></script>
    <script src="{% static 'js/dataTables.bootstrap5.min.js' %}" type="3ef0ac283bd62b58e08a32f8-text/javascript"></script>

    <!-- Select2 JS -->
    <script src="{% static 'plugins/select2/js/select2.min.js' %}" type="3ef0ac283bd62b58e08a32f8-text/javascript"></script>

    <!-- Daterangepikcer JS -->
    <script src="{% static 'js/moment.min.js' %}" type="3ef0ac283bd62b58e08a32f8-text/javascript"></script>
    <script src="{% static 'plugins/daterangepicker/daterangepicker.js' %}" type="3ef0ac283bd62b58e08a32f8-text/javascript"></script>

    <!-- Mobile Input -->
    <script src="{% static 'plugins/intltelinput/js/intlTelInput.js' %}" type="3ef0ac283bd62b58e08a32f8-text/javascript"></script>

    <!-- Custom JS -->
    <script src="{% static 'js/script.js' %}" type="3ef0ac283bd62b58e08a32f8-text/javascript"></script>

<script src="{% static 'cdn-cgi/scripts/7d0fa10a/cloudflare-static/rocket-loader.min-2.js' %}" data-cf-settings="3ef0ac283bd62b58e08a32f8-|49" defer=""></script>




   <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector('#clientForm');

            if (!form.dataset.listenerAdded) {
                form.dataset.listenerAdded = "true"; // âœ… prevent duplicate
                form.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    // ... fetch code
                    const formData = new FormData(form);

                    const response = await fetch("{% url 'managementSystem:register_client' %}", {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' },
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert(data.message);
                        form.reset();
                        document.getElementById('client_id').value = ""; // reset edit mode
                        document.getElementById('add_clients').style.display = 'none';
                        location.reload(); // reload to refresh table
                    } else {
                        alert(data.message);
                    }
                });
            }

            // Handle Edit button click
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', async function () {
                    $('#add_clients').modal('show');
                    const clientId = this.dataset.id;

                    const res = await fetch("{% url 'managementSystem:get_client' 0 %}".replace('0', clientId));
                    const client = await res.json();

                    // Fill form fields
                    document.getElementById('client_id').value = client.id;
                    document.querySelector('input[name="name"]').value = client.name;
                    document.querySelector('input[name="address"]').value = client.address;
                    document.querySelector('input[name="contact_email"]').value = client.email;
                    document.querySelector('input[name="phone"]').value = client.phone;
                                       
                });
            });
        });

        $('.clsrfsh').click(function(){
            location.reload();
        });

         // CSRF helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Event delegation for delete
        document.addEventListener('click', async function (e) {
            if (e.target.classList.contains('delete-btn')) {
                e.preventDefault();

                const clientId = e.target.dataset.id;
                if (!confirm("Are you sure you want to delete this client?")) return;

                const res = await fetch(`/management/delete/${clientId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                    }
                });

                const data = await res.json();
                if (data.success) {
                    alert(data.message);
                    e.target.closest('tr').remove();
                    location.reload();
                } else {
                    alert(data.message);
                }
            }
        });
    </script>

{% endblock %}